Monadic implementation of the encoder.
